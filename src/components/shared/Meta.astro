---
import {
  DEFAULT_SITE_DESCRIPTION,
  DEFAULT_SITE_TITLE,
  SITE_TITLE_SUFFIX,
  SITE_ORIGIN,
  OG_LOCALE,
  SITE_NAME,
  PUBLISHER_NAME,
  AUTHOR_NAME,
  TWITTER_HANDLE,
} from "../../constants";

interface Props {
  title?: string;
  description?: string;
  url?: string;
  image?: string;
  type?: "website" | "article";
  publishedTime?: string; // ISO string
  modifiedTime?: string; // ISO string
  authorName?: string;
  keywords?: string[];
}

const {
  title,
  description,
  url,
  image,
  type = "website",
  publishedTime,
  modifiedTime,
  authorName,
  keywords,
} = Astro.props as Props;

const effectiveTitle = `${title ?? DEFAULT_SITE_TITLE}${SITE_TITLE_SUFFIX}`;
const effectiveDescription = description ?? DEFAULT_SITE_DESCRIPTION;

const resolveImage = (img?: string) => {
  if (!img) return undefined;
  if (img.startsWith("http://") || img.startsWith("https://")) return img;
  return `${SITE_ORIGIN}${img.startsWith("/") ? "" : "/"}${img}`;
};

const effectiveImage = resolveImage(image);
const twitterCard = effectiveImage ? "summary_large_image" : "summary";
const canonical =
  url && (url.startsWith("http://") || url.startsWith("https://"))
    ? url
    : `${SITE_ORIGIN}${url ?? Astro.url.pathname}`;
const isHome = Astro.url.pathname === "/";
const resolvedAuthor = authorName ?? AUTHOR_NAME;
---

<!-- Primary Meta Tags -->
<meta name="title" content={effectiveTitle} />
<meta name="description" content={effectiveDescription} />
<meta name="author" content={resolvedAuthor} />
{keywords && <meta name="keywords" content={keywords.join(", ")} />}
<meta name="robots" content="index,follow" />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:title" content={effectiveTitle} />
<meta property="og:description" content={effectiveDescription} />
<meta property="og:url" content={canonical} />
{effectiveImage && <meta property="og:image" content={effectiveImage} />}
<meta property="og:site_name" content={SITE_NAME} />
<meta property="og:locale" content={OG_LOCALE} />
{
  type === "article" && (
    <>
      <meta property="article:author" content={resolvedAuthor} />
      {publishedTime && (
        <meta property="article:published_time" content={publishedTime} />
      )}
      {modifiedTime && (
        <meta property="article:modified_time" content={modifiedTime} />
      )}
    </>
  )
}

<!-- Twitter -->
<meta name="twitter:card" content={twitterCard} />
<meta name="twitter:site" content={TWITTER_HANDLE} />
<meta name="twitter:creator" content={TWITTER_HANDLE} />
<meta name="twitter:title" content={effectiveTitle} />
<meta name="twitter:description" content={effectiveDescription} />
{effectiveImage && <meta name="twitter:image" content={effectiveImage} />}

<link rel="canonical" href={canonical} />

<!-- Structured Data -->
{
  isHome && (
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "WebSite",
        name: SITE_NAME,
        url: SITE_ORIGIN,
        description: effectiveDescription,
        publisher: {
          "@type": "Person",
          name: PUBLISHER_NAME,
          url: SITE_ORIGIN,
          image: resolveImage("/apple-touch-icon.png"),
        },
      })}
    />
  )
}

{
  type === "article" && (
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Article",
        headline: title ?? DEFAULT_SITE_TITLE,
        description: effectiveDescription,
        datePublished: publishedTime,
        ...(modifiedTime ? { dateModified: modifiedTime } : {}),
        mainEntityOfPage: {
          "@type": "WebPage",
          "@id": canonical,
        },
        author: {
          "@type": "Person",
          name: resolvedAuthor,
          url: SITE_ORIGIN,
        },
        publisher: {
          "@type": "Person",
          name: PUBLISHER_NAME,
          url: SITE_ORIGIN,
        },
        ...(effectiveImage
          ? {
              image: {
                "@type": "ImageObject",
                url: effectiveImage,
              },
            }
          : {}),
      })}
    />
  )
}

<script
  type="application/ld+json"
  is:inline
  set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: Astro.url.pathname
      .split("/")
      .filter(Boolean)
      .reduce(
        (acc, curr, i, arr) => {
          const url = `/${arr.slice(0, i + 1).join("/")}`;
          acc.push({
            "@type": "ListItem",
            position: i + 2,
            name: curr.charAt(0).toUpperCase() + curr.slice(1),
            item: `${SITE_ORIGIN}${url}`,
          });
          return acc;
        },
        [
          {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: SITE_ORIGIN,
          },
        ],
      ),
  })}
/>
