---
import {
  DEFAULT_SITE_DESCRIPTION,
  DEFAULT_SITE_TITLE,
  SITE_TITLE_SUFFIX,
  SITE_ORIGIN,
  OG_LOCALE,
  SITE_NAME,
  PUBLISHER_NAME,
  AUTHOR_NAME,
} from "../constants";

interface Props {
  title?: string;
  description?: string;
  url?: string;
  image?: string;
  type?: "website" | "article";
  publishedTime?: string; // ISO string
  modifiedTime?: string; // ISO string
  authorName?: string;
}

const { title, description, url, image, type = "website", publishedTime, modifiedTime, authorName } = Astro.props as Props;

const effectiveTitle = `${title ?? DEFAULT_SITE_TITLE}${SITE_TITLE_SUFFIX}`;
const effectiveDescription = description ?? DEFAULT_SITE_DESCRIPTION;
const twitterCard = image ? "summary_large_image" : "summary";
const canonical = (url && (url.startsWith("http://") || url.startsWith("https://")))
  ? url
  : `${SITE_ORIGIN}${url ?? Astro.url.pathname}`;
const isHome = Astro.url.pathname === "/";
const resolvedAuthor = authorName ?? AUTHOR_NAME;
---

<!-- Primary Meta Tags -->
<meta name="description" content={effectiveDescription} />
<meta name="robots" content="index,follow" />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:title" content={effectiveTitle} />
<meta property="og:description" content={effectiveDescription} />
<meta property="og:url" content={canonical} />
{image && <meta property="og:image" content={image} />}
<meta property="og:site_name" content={SITE_NAME} />
<meta property="og:locale" content={OG_LOCALE} />
{type === 'article' && publishedTime && <meta property="article:published_time" content={publishedTime} />}
{type === 'article' && modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}

<!-- Twitter -->
<meta name="twitter:card" content={twitterCard} />
<meta name="twitter:title" content={effectiveTitle} />
<meta name="twitter:description" content={effectiveDescription} />
{image && <meta name="twitter:image" content={image} />}

<link rel="canonical" href={canonical} />

<!-- Structured Data -->
{isHome && (
  <script type="application/ld+json" set:html={JSON.stringify({
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: SITE_NAME,
    url: SITE_ORIGIN,
    publisher: {
      '@type': 'Person',
      name: PUBLISHER_NAME,
    },
  })} />
)}

{type === 'article' && publishedTime && (
  <script type="application/ld+json" set:html={JSON.stringify({
    '@context': 'https://schema.org',
    '@type': 'Article',
    headline: title ?? DEFAULT_SITE_TITLE,
    description: effectiveDescription,
    datePublished: publishedTime,
    ...(modifiedTime ? { dateModified: modifiedTime } : {}),
    mainEntityOfPage: canonical,
    author: {
      '@type': 'Person',
      name: resolvedAuthor,
    },
    publisher: {
      '@type': 'Person',
      name: PUBLISHER_NAME,
    },
    ...(image ? { image } : {}),
  })} />
)}
